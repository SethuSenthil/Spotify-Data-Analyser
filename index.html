<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Data Analyser</title>
    <link rel="stylesheet" type="text/css" href="https://sethusenthil.com/Product-Sans/api/font.css">
</head>
<style>
    input[type=button],
    input[type=submit],
    input[type=reset] {
        background-color: #4CAF50;
        border: none;
        color: white;
        padding: 16px 32px;
        text-decoration: none;
        margin: 4px 2px;
        cursor: pointer;
    }

    .template {
        display: none;
    }

    .hide {
        display: none;
    }

    .fSHow {
        display: block !important;
    }
</style>

<body class="gfont">
    <div id="home" class="view">
        <h1>Life Time Analytics:</h1>
        <p>Play Time:</p>
        <p>Top Songs:</p>
        <p>Top Artists:</p>

        <h1>Years:</h1>
        <div id="years">
            <input type="button" value="2020" class="template">
        </div>
    </div>

    <div id="months" class="view">
        <h1>Yearly Analytics:</h1>
        <p>Play Time:</p>
        <p>Top Songs:</p>
        <p>Top Artists:</p>

        <h1>Months:</h1>
        <div id="monthDiaply">
            <input type="button" value="2020" class="template">
        </div>
    </div>

    <div id="days" class="view">
        <h1>Monthly Analytics:</h1>
        <p>Play Time: <span id="playtime"></span></p>
        <p>Top Songs:</p>
        <div id="topsongs">
            <input type="button" value="2020" class="template">
        </div>
        <p>Top Artists:</p>

        <h1>Days:</h1>
        <div id="dayDisplay">
            <input type="button" value="2020" class="template">
        </div>
    </div>

</body>

<script>
    let data = ''
    let generated = {
        home: false
    }

    function msToTime(duration) {
  var milliseconds = parseInt((duration % 1000) / 100),
    seconds = Math.floor((duration / 1000) % 60),
    minutes = Math.floor((duration / (1000 * 60)) % 60),
    hours = Math.floor((duration / (1000 * 60 * 60)) % 24);

  hours = (hours < 10) ? "0" + hours : hours;
  minutes = (minutes < 10) ? "0" + minutes : minutes;
  seconds = (seconds < 10) ? "0" + seconds : seconds;

  return hours + "hours " + minutes + "minutes " + seconds + "seconds"
}


    fetch('./master.json')
        .then(res => res.json())
        .then((res) => {
            data = res
            console.log(data)
            main()
        })

    window.addEventListener("hashchange", (val) => {
        let hash = val.newURL.split('#')[1]
        console.log(hash)
        main(hash)

    }, false);

    const main = (hash) => {
        if (!hash)
            hash = window.location.hash

        document.querySelectorAll('.view').forEach((view) => {
            view.classList.add('hide')
        })

        if ((hash == undefined || hash == '') && !generated.home) {
            generated.home = true

            let view = document.querySelector('#home')
            view.classList.remove('hide')

            let template = view.querySelector('.template')

            for (const [year, yearData] of Object.entries(data.years)) {
                let newBtn = template.cloneNode(true)
                newBtn.value = year
                newBtn.classList.remove('template')
                newBtn.addEventListener('click', () => window.location.hash = JSON.stringify({
                    year: year
                }))
                view.appendChild(newBtn);
            }

        } else {
            if (!generated.home)
                window.location.href = window.location.href.split('#')[0]

            hash = JSON.parse(decodeURI(hash))
            console.log(hash)

        if(!hash.month){

            let view = document.querySelector('#months')
            view.classList.remove('hide')

            const monthMap = {
                [1]: 'January',
                [2]: 'February',
                [3]: 'March',
                [4]: 'April',
                [5]: 'May',
                [6]: 'June',
                [7]: 'July',
                [8]: 'August',
                [9]: 'September',
                [10]: 'October',
                [11]: 'November',
                [12]: 'December',
            }

            let template = view.querySelector('.template')

            for (let i = 1; i <= 12; i++) {
                let newBtn = template.cloneNode(true)
                newBtn.value = monthMap[i]
                newBtn.classList.remove('template')
                newBtn.addEventListener('click', () => {
                    hash.month = i
                    window.location.hash = JSON.stringify(hash)
                })
                view.querySelector('#monthDiaply').appendChild(newBtn);


            }
        }
    }

    if(!hash.day && hash.month){
        let view = document.querySelector('#days')
            view.classList.remove('hide')




    let days = []

    for (const [day, dayData] of Object.entries(data.years[hash.year].months[hash.month].history)) {
      days.push(day)
    }

    days.sort()
    console.log(days)

    days.forEach(day => {
        let template = view.querySelector('#dayDisplay').querySelector('.template')
        let newBtn = template.cloneNode(true)
    newBtn.value = day
    newBtn.classList.remove('template')
    newBtn.addEventListener('click', () => {
        hash.day = day
        window.location.hash = JSON.stringify(hash)
    });

    view.querySelector('#dayDisplay').appendChild(newBtn);

});


data.years[hash.year].months[hash.month].tally.slice(0, 20).forEach(song => {
    let template = view.querySelector('#topsongs').querySelector('.template')
        let newBtn = template.cloneNode(true)
    newBtn.value = data.trackIndexes[song.nameTag][1]
    newBtn.classList.remove('template')

    view.querySelector('#topsongs').appendChild(newBtn);

});


view.querySelector('#playtime').innerText = msToTime(data.years[hash.year].months[hash.month].overallListenTime)


    }
}
</script>

</html>